<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .ticker-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Stock Analytics Dashboard</h1>
                    <p class="text-gray-600">Compare stocks against IPC index with detailed metrics</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-chart-line mr-1"></i> Real-time
                    </span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar -->
            <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6 h-fit sticky top-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Stock Selection</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Stock</label>
                    <div class="relative">
                        <select id="tickerSelect" class="ticker-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Choose a stock</option>
                            <option value="AMXL.MX">America Movil (AMXL.MX)</option>
                            <option value="WALMEX.MX">Walmart Mexico (WALMEX.MX)</option>
                            <option value="GFNORTEO.MX">Grupo Financiero Banorte (GFNORTEO.MX)</option>
                            <option value="FEMSAUBD.MX">Femsa (FEMSAUBD.MX)</option>
                            <option value="TLEVISACPO.MX">Televisa (TLEVISACPO.MX)</option>
                            <option value="ASURB.MX">Grupo Aeroportuario del Sureste (ASURB.MX)</option>
                            <option value="GMEXICOB.MX">Grupo Mexico (GMEXICOB.MX)</option>
                            <option value="BIMBOA.MX">Grupo Bimbo (BIMBOA.MX)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="timeRange" class="ticker-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1mo">1 Month</option>
                            <option value="3mo" selected>3 Months</option>
                            <option value="6mo">6 Months</option>
                            <option value="1y">1 Year</option>
                            <option value="2y">2 Years</option>
                            <option value="5y">5 Years</option>
                        </select>
                    </div>
                </div>

                <button id="fetchDataBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i> Fetch Data
                </button>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500 mb-3">Recently Viewed</h3>
                    <div id="recentTickers" class="space-y-2">
                        <!-- Recent tickers will appear here -->
                    </div>
                </div>
            </div>

            <!-- Main Dashboard -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Loading State -->
                <div id="loadingState" class="hidden bg-white rounded-xl shadow-md p-8 text-center">
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full spinner mb-4"></div>
                        <h3 class="text-xl font-medium text-gray-800 mb-2">Fetching Stock Data</h3>
                        <p class="text-gray-600">Please wait while we retrieve the latest market information...</p>
                    </div>
                </div>

                <!-- Stock Overview -->
                <div id="stockOverview" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 id="stockName" class="text-2xl font-bold text-gray-800">-</h2>
                            <div class="flex items-center mt-1">
                                <span id="stockTicker" class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm font-medium mr-2">-</span>
                                <span id="stockExchange" class="text-gray-600 text-sm">-</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div id="currentPrice" class="text-3xl font-bold text-gray-800">-</div>
                            <div id="priceChange" class="flex items-center justify-end mt-1">
                                <span class="text-sm font-medium">-</span>
                                <span class="ml-1 text-sm">(-%)</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-gray-500 text-sm font-medium mb-1">Market Cap</div>
                            <div id="marketCap" class="text-lg font-semibold text-gray-800">-</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-gray-500 text-sm font-medium mb-1">Volume</div>
                            <div id="volume" class="text-lg font-semibold text-gray-800">-</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-gray-500 text-sm font-medium mb-1">P/E Ratio</div>
                            <div id="peRatio" class="text-lg font-semibold text-gray-800">-</div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div id="chartSection" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Performance vs IPC</h2>
                        <div class="flex space-x-2">
                            <button class="chart-period-btn px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-lg" data-period="1w">1W</button>
                            <button class="chart-period-btn px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded-lg" data-period="1m">1M</button>
                            <button class="chart-period-btn px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded-lg" data-period="3m">3M</button>
                            <button class="chart-period-btn px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded-lg" data-period="1y">1Y</button>
                            <button class="chart-period-btn px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded-lg" data-period="max">MAX</button>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Metrics Section -->
                <div id="metricsSection" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Performance Metrics</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Returns -->
                        <div class="bg-gray-50 rounded-lg p-5 card-hover transition duration-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                    <i class="fas fa-arrow-trend-up text-blue-600"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-800">Returns</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">1 Month</span>
                                    <span id="return1m" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">3 Months</span>
                                    <span id="return3m" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">6 Months</span>
                                    <span id="return6m" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">1 Year</span>
                                    <span id="return1y" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">YTD</span>
                                    <span id="returnYtd" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Volatility -->
                        <div class="bg-gray-50 rounded-lg p-5 card-hover transition duration-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-purple-100 p-2 rounded-lg mr-3">
                                    <i class="fas fa-bolt text-purple-600"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-800">Volatility</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Daily Volatility</span>
                                    <span id="dailyVolatility" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Annual Volatility</span>
                                    <span id="annualVolatility" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Beta (vs IPC)</span>
                                    <span id="beta" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Sharpe Ratio</span>
                                    <span id="sharpeRatio" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Max Drawdown</span>
                                    <span id="maxDrawdown" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Valuation -->
                        <div class="bg-gray-50 rounded-lg p-5 card-hover transition duration-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-green-100 p-2 rounded-lg mr-3">
                                    <i class="fas fa-coins text-green-600"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-800">Valuation</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">P/E Ratio</span>
                                    <span id="peRatioMetric" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">P/B Ratio</span>
                                    <span id="pbRatio" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Dividend Yield</span>
                                    <span id="dividendYield" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">EPS</span>
                                    <span id="eps" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ROE</span>
                                    <span id="roe" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Technicals -->
                        <div class="bg-gray-50 rounded-lg p-5 card-hover transition duration-200">
                            <div class="flex items-center mb-4">
                                <div class="bg-yellow-100 p-2 rounded-lg mr-3">
                                    <i class="fas fa-chart-simple text-yellow-600"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-800">Technical Indicators</h3>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">50-Day MA</span>
                                    <span id="ma50" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">200-Day MA</span>
                                    <span id="ma200" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">RSI (14-day)</span>
                                    <span id="rsi" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">52-Week High</span>
                                    <span id="week52High" class="font-medium">-</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">52-Week Low</span>
                                    <span id="week52Low" class="font-medium">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- News Section -->
                <div id="newsSection" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">Latest News</h2>
                    <div id="newsContainer" class="space-y-4">
                        <!-- News items will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let performanceChart;
        let stockData = {};
        let ipcData = {};
        let currentTicker = '';
        
        // DOM elements
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const tickerSelect = document.getElementById('tickerSelect');
        const timeRange = document.getElementById('timeRange');
        const loadingState = document.getElementById('loadingState');
        const stockOverview = document.getElementById('stockOverview');
        const chartSection = document.getElementById('chartSection');
        const metricsSection = document.getElementById('metricsSection');
        const newsSection = document.getElementById('newsSection');
        const recentTickers = document.getElementById('recentTickers');
        
        // Event listeners
        fetchDataBtn.addEventListener('click', fetchStockData);
        document.querySelectorAll('.chart-period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active button
                document.querySelectorAll('.chart-period-btn').forEach(b => {
                    b.classList.remove('bg-blue-100', 'text-blue-800');
                    b.classList.add('bg-gray-100', 'text-gray-800');
                });
                this.classList.remove('bg-gray-100', 'text-gray-800');
                this.classList.add('bg-blue-100', 'text-blue-800');
                
                // Update chart with selected period
                updateChart(this.dataset.period);
            });
        });
        
        // Initialize with some recent tickers
        updateRecentTickers(['AMXL.MX', 'WALMEX.MX', 'GFNORTEO.MX']);
        
        // Fetch stock data from Yahoo Finance
        async function fetchStockData() {
            const ticker = tickerSelect.value;
            const range = timeRange.value;
            
            if (!ticker) {
                alert('Please select a stock ticker');
                return;
            }
            
            currentTicker = ticker;
            addToRecentTickers(ticker);
            
            // Show loading state
            loadingState.classList.remove('hidden');
            stockOverview.classList.add('hidden');
            chartSection.classList.add('hidden');
            metricsSection.classList.add('hidden');
            newsSection.classList.add('hidden');
            
            try {
                // Fetch stock data and IPC data in parallel
                const [stockRes, ipcRes] = await Promise.all([
                    fetchYahooFinanceData(ticker, range),
                    fetchYahooFinanceData('^MXX', range) // IPC index
                ]);
                
                stockData = processData(stockRes);
                ipcData = processData(ipcRes);
                
                // Update UI
                updateStockOverview(ticker);
                updateChart(range);
                updateMetrics();
                updateNews(ticker);
                
                // Hide loading and show content
                loadingState.classList.add('hidden');
                stockOverview.classList.remove('hidden');
                chartSection.classList.remove('hidden');
                metricsSection.classList.remove('hidden');
                newsSection.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error fetching data:', error);
                loadingState.classList.add('hidden');
                alert('Error fetching data. Please try again later.');
            }
        }
        
        // Fetch data from Yahoo Finance API (using a proxy)
        async function fetchYahooFinanceData(ticker, range) {
            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=${range}`;
            
            try {
                // In a real app, you would use a proper backend proxy to avoid CORS issues
                // This is a simplified version for demonstration
                const response = await axios.get(url);
                return response.data;
            } catch (error) {
                console.error('Error fetching from Yahoo Finance:', error);
                throw error;
            }
        }
        
        // Process raw Yahoo Finance data
        function processData(data) {
            const result = {};
            const chart = data.chart.result[0];
            
            result.timestamp = chart.timestamp;
            result.indicators = chart.indicators;
            result.meta = chart.meta;
            
            // Get closing prices
            result.closes = chart.indicators.quote[0].close;
            
            // Calculate returns
            result.returns = calculateReturns(result.closes);
            
            return result;
        }
        
        // Calculate returns from price data
        function calculateReturns(prices) {
            const returns = [];
            for (let i = 1; i < prices.length; i++) {
                returns.push((prices[i] - prices[i-1]) / prices[i-1]);
            }
            return returns;
        }
        
        // Update stock overview section
        function updateStockOverview(ticker) {
            const meta = stockData.meta;
            
            document.getElementById('stockName').textContent = meta.symbol;
            document.getElementById('stockTicker').textContent = ticker;
            document.getElementById('stockExchange').textContent = 'BMV';
            
            const currentPrice = meta.regularMarketPrice;
            const previousClose = meta.chartPreviousClose;
            const change = currentPrice - previousClose;
            const changePercent = (change / previousClose) * 100;
            
            document.getElementById('currentPrice').textContent = formatCurrency(currentPrice);
            
            const priceChangeElement = document.getElementById('priceChange');
            priceChangeElement.innerHTML = '';
            
            const changeSpan = document.createElement('span');
            changeSpan.className = 'text-sm font-medium';
            changeSpan.textContent = formatCurrency(change) + ` (${changePercent.toFixed(2)}%)`;
            
            if (change >= 0) {
                changeSpan.classList.add('text-green-600');
                priceChangeElement.innerHTML = '<i class="fas fa-caret-up text-green-600 mr-1"></i>';
            } else {
                changeSpan.classList.add('text-red-600');
                priceChangeElement.innerHTML = '<i class="fas fa-caret-down text-red-600 mr-1"></i>';
            }
            
            priceChangeElement.appendChild(changeSpan);
            
            // Update other metrics
            document.getElementById('marketCap').textContent = meta.marketCap ? formatCurrency(meta.marketCap) : 'N/A';
            document.getElementById('volume').textContent = meta.regularMarketVolume ? formatNumber(meta.regularMarketVolume) : 'N/A';
            document.getElementById('peRatio').textContent = meta.trailingPE ? meta.trailingPE.toFixed(2) : 'N/A';
        }
        
        // Create or update the performance chart
        function updateChart(range) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const stockDates = stockData.timestamp.map(t => new Date(t * 1000));
            const stockCloses = stockData.closes;
            const ipcCloses = ipcData.closes;
            
            // Normalize prices to percentage change from first day
            const normalizedStock = normalizePrices(stockCloses);
            const normalizedIpc = normalizePrices(ipcCloses);
            
            // Use the shorter array length to ensure matching dates
            const minLength = Math.min(stockDates.length, normalizedStock.length, normalizedIpc.length);
            const displayDates = stockDates.slice(0, minLength);
            const displayStock = normalizedStock.slice(0, minLength);
            const displayIpc = normalizedIpc.slice(0, minLength);
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayDates.map(date => formatDate(date)),
                    datasets: [
                        {
                            label: currentTicker,
                            data: displayStock,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'IPC',
                            data: displayIpc,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: false,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)}%`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Normalize prices to percentage change from first day
        function normalizePrices(prices) {
            if (!prices || prices.length === 0) return [];
            
            const firstPrice = prices[0];
            return prices.map(price => ((price - firstPrice) / firstPrice) * 100);
        }
        
        // Update performance metrics
        function updateMetrics() {
            // Calculate returns
            const closes = stockData.closes;
            const returns = stockData.returns;
            
            if (closes.length > 0) {
                const lastPrice = closes[closes.length - 1];
                
                // 1 month return (approx 21 trading days)
                const days1m = Math.min(21, closes.length - 1);
                const return1m = ((lastPrice - closes[closes.length - 1 - days1m]) / closes[closes.length - 1 - days1m]) * 100;
                document.getElementById('return1m').textContent = return1m.toFixed(2) + '%';
                
                // 3 months return (approx 63 trading days)
                const days3m = Math.min(63, closes.length - 1);
                const return3m = ((lastPrice - closes[closes.length - 1 - days3m]) / closes[closes.length - 1 - days3m]) * 100;
                document.getElementById('return3m').textContent = return3m.toFixed(2) + '%';
                
                // 6 months return (approx 126 trading days)
                const days6m = Math.min(126, closes.length - 1);
                const return6m = ((lastPrice - closes[closes.length - 1 - days6m]) / closes[closes.length - 1 - days6m]) * 100;
                document.getElementById('return6m').textContent = return6m.toFixed(2) + '%';
                
                // 1 year return (approx 252 trading days)
                const days1y = Math.min(252, closes.length - 1);
                const return1y = ((lastPrice - closes[closes.length - 1 - days1y]) / closes[closes.length - 1 - days1y]) * 100;
                document.getElementById('return1y').textContent = return1y.toFixed(2) + '%';
                
                // YTD return (from first day of current year)
                const firstDayOfYear = getFirstTradingDayOfYear();
                const ytdReturn = ((lastPrice - firstDayOfYear) / firstDayOfYear) * 100;
                document.getElementById('returnYtd').textContent = ytdReturn.toFixed(2) + '%';
            }
            
            // Calculate volatility
            if (returns.length > 0) {
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                const dailyVolatility = Math.sqrt(variance);
                const annualVolatility = dailyVolatility * Math.sqrt(252);
                
                document.getElementById('dailyVolatility').textContent = (dailyVolatility * 100).toFixed(2) + '%';
                document.getElementById('annualVolatility').textContent = (annualVolatility * 100).toFixed(2) + '%';
                
                // Calculate Beta (simplified)
                const stockReturns = stockData.returns;
                const ipcReturns = ipcData.returns;
                
                if (stockReturns.length > 0 && ipcReturns.length > 0) {
                    const minLength = Math.min(stockReturns.length, ipcReturns.length);
                    const cov = covariance(stockReturns.slice(0, minLength), ipcReturns.slice(0, minLength));
                    const varIpc = varianceOfArray(ipcReturns.slice(0, minLength));
                    const beta = cov / varIpc;
                    
                    document.getElementById('beta').textContent = beta.toFixed(2);
                }
                
                // Sharpe ratio (simplified, assuming 0% risk-free rate)
                const sharpeRatio = (mean / dailyVolatility) * Math.sqrt(252);
                document.getElementById('sharpeRatio').textContent = sharpeRatio.toFixed(2);
                
                // Max drawdown
                const maxDrawdown = calculateMaxDrawdown(stockData.closes);
                document.getElementById('maxDrawdown').textContent = (maxDrawdown * 100).toFixed(2) + '%';
            }
            
            // Valuation metrics (mock data for demonstration)
            document.getElementById('peRatioMetric').textContent = stockData.meta.trailingPE ? stockData.meta.trailingPE.toFixed(2) : 'N/A';
            document.getElementById('pbRatio').textContent = (Math.random() * 5 + 1).toFixed(2);
            document.getElementById('dividendYield').textContent = (Math.random() * 5).toFixed(2) + '%';
            document.getElementById('eps').textContent = formatCurrency(Math.random() * 10 + 1);
            document.getElementById('roe').textContent = (Math.random() * 30 + 5).toFixed(2) + '%';
            
            // Technical indicators (mock data for demonstration)
            const lastClose = stockData.closes[stockData.closes.length - 1];
            document.getElementById('ma50').textContent = formatCurrency(lastClose * (0.98 + Math.random() * 0.04));
            document.getElementById('ma200').textContent = formatCurrency(lastClose * (0.95 + Math.random() * 0.06));
            document.getElementById('rsi').textContent = (30 + Math.random() * 40).toFixed(2);
            document.getElementById('week52High').textContent = formatCurrency(lastClose * (1.05 + Math.random() * 0.15));
            document.getElementById('week52Low').textContent = formatCurrency(lastClose * (0.85 - Math.random() * 0.10));
        }
        
        // Update news section
        function updateNews(ticker) {
            const newsContainer = document.getElementById('newsContainer');
            newsContainer.innerHTML = '';
            
            // Mock news data (in a real app, you would fetch from a news API)
            const mockNews = [
                {
                    title: `${ticker.split('.')[0]} reports Q2 earnings above estimates`,
                    source: 'El Financiero',
                    date: '2 hours ago',
                    summary: 'The company reported earnings per share of $1.25, beating analyst estimates of $1.15. Revenue came in at $5.2 billion versus the expected $5.0 billion.'
                },
                {
                    title: `Analysts raise price target for ${ticker.split('.')[0]} after strong results`,
                    source: 'Expansión',
                    date: '5 hours ago',
                    summary: 'Several analysts have increased their price targets following the company\'s better-than-expected quarterly results and optimistic guidance.'
                },
                {
                    title: `${ticker.split('.')[0]} announces new CEO`,
                    source: 'El Economista',
                    date: '1 day ago',
                    summary: 'The board of directors has appointed a new Chief Executive Officer, effective immediately. The incoming CEO has previously served as COO for the past 3 years.'
                },
                {
                    title: `Sector outlook: What's next for ${ticker.split('.')[0]} and competitors`,
                    source: 'Forbes México',
                    date: '2 days ago',
                    summary: 'Industry analysts weigh in on the current market conditions and how major players in the sector are positioned for the coming quarters.'
                }
            ];
            
            mockNews.forEach(newsItem => {
                const newsElement = document.createElement('div');
                newsElement.className = 'p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200';
                newsElement.innerHTML = `
                    <h3 class="font-medium text-lg text-gray-800 mb-1">${newsItem.title}</h3>
                    <div class="flex items-center text-sm text-gray-500 mb-2">
                        <span>${newsItem.source}</span>
                        <span class="mx-2">•</span>
                        <span>${newsItem.date}</span>
                    </div>
                    <p class="text-gray-600">${newsItem.summary}</p>
                `;
                newsContainer.appendChild(newsElement);
            });
        }
        
        // Update recent tickers list
        function updateRecentTickers(tickers) {
            recentTickers.innerHTML = '';
            tickers.forEach(ticker => {
                const tickerElement = document.createElement('div');
                tickerElement.className = 'flex items-center justify-between p-2 hover:bg-gray-100 rounded-lg cursor-pointer transition duration-200';
                tickerElement.innerHTML = `
                    <span class="font-medium">${ticker}</span>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                `;
                tickerElement.addEventListener('click', () => {
                    tickerSelect.value = ticker;
                    fetchStockData();
                });
                recentTickers.appendChild(tickerElement);
            });
        }
        
        // Add a ticker to recent tickers (if not already there)
        function addToRecentTickers(ticker) {
            const currentTickers = Array.from(recentTickers.querySelectorAll('div')).map(el => el.querySelector('span').textContent);
            if (!currentTickers.includes(ticker)) {
                const newTickers = [ticker, ...currentTickers].slice(0, 3);
                updateRecentTickers(newTickers);
            }
        }
        
        // Helper functions
        function formatCurrency(value) {
            if (value === null || value === undefined) return 'N/A';
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatNumber(value) {
            if (value === null || value === undefined) return 'N/A';
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(2) + 'K';
            }
            return value.toLocaleString();
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function calculateMaxDrawdown(prices) {
            if (!prices || prices.length === 0) return 0;
            
            let peak = prices[0];
            let maxDrawdown = 0;
            
            for (let i = 1; i < prices.length; i++) {
                if (prices[i] > peak) {
                    peak = prices[i];
                } else {
                    const drawdown = (peak - prices[i]) / peak;
                    if (drawdown > maxDrawdown) {
                        maxDrawdown = drawdown;
                    }
                }
            }
            
            return maxDrawdown;
        }
        
        function covariance(arr1, arr2) {
            if (arr1.length !== arr2.length || arr1.length === 0) return 0;
            
            const mean1 = arr1.reduce((a, b) => a + b, 0) / arr1.length;
            const mean2 = arr2.reduce((a, b) => a + b, 0) / arr2.length;
            
            let cov = 0;
            for (let i = 0; i < arr1.length; i++) {
                cov += (arr1[i] - mean1) * (arr2[i] - mean2);
            }
            
            return cov / arr1.length;
        }
        
        function varianceOfArray(arr) {
            if (arr.length === 0) return 0;
            
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            return arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
        }
        
        function getFirstTradingDayOfYear() {
            // This is a simplified version - in a real app, you would have the actual first trading day price
            const today = new Date();
            const yearStart = new Date(today.getFullYear(), 0, 1);
            
            // Find the first trading day (just use the first available price in our data for this year)
            for (let i = 0; i < stockData.timestamp.length; i++) {
                const date = new Date(stockData.timestamp[i] * 1000);
                if (date >= yearStart) {
                    return stockData.closes[i];
                }
            }
            
            // If no data found for this year, use the first price available
            return stockData.closes[0];
        }
    </script>
</body>
</html>
